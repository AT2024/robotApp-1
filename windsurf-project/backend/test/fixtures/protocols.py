"""
Protocol definitions for robot drivers.
Both real drivers and simulators MUST implement these protocols.
This prevents simulator drift from real API.
"""
from typing import Protocol, List, Dict, Any, Optional, runtime_checkable


@runtime_checkable
class MecaDriverProtocol(Protocol):
    """Protocol that MecaSimulator and real Mecademic driver must implement."""

    # Connection
    async def connect(self, ip: str) -> bool: ...
    async def disconnect(self) -> bool: ...

    # Status
    async def get_status(self) -> Dict[str, Any]: ...
    async def get_joints(self) -> List[float]: ...

    # Activation/Homing
    async def activate_robot(self) -> None: ...
    async def home_robot(self) -> None: ...
    async def wait_homed(self, timeout: float = 30.0) -> None: ...

    # Movement (sync - queued in robot buffer)
    def MovePose(self, x: float, y: float, z: float, rx: float, ry: float, rz: float) -> None: ...
    def MoveJoints(self, *joints: float) -> None: ...
    def Delay(self, duration: float) -> None: ...
    def GripperOpen(self) -> None: ...
    def GripperClose(self) -> None: ...

    # Configuration
    def SetGripperForce(self, force: int) -> None: ...
    def SetJointAcc(self, acc: int) -> None: ...
    def SetJointVel(self, vel: int) -> None: ...
    def SetTorqueLimits(self, *limits: float) -> None: ...
    def SetTorqueLimitsCfg(self, *cfg: int) -> None: ...
    def SetConf(self, *conf: int) -> None: ...
    def SetBlending(self, blending: int) -> None: ...

    # Error handling
    async def reset_error(self) -> None: ...
    async def resume_motion(self) -> None: ...


@runtime_checkable
class OT2DriverProtocol(Protocol):
    """Protocol for OT-2 driver and simulator."""

    # Connection
    async def connect(self) -> bool: ...
    async def disconnect(self) -> bool: ...

    # Status
    async def get_health(self) -> Dict[str, Any]: ...
    async def get_runs(self) -> List[Dict[str, Any]]: ...

    # Protocol execution
    async def create_run(self, protocol_id: str) -> Dict[str, Any]: ...
    async def execute_run(self, run_id: str) -> Dict[str, Any]: ...
    async def get_run_status(self, run_id: str) -> Dict[str, Any]: ...

    # Commands
    async def home(self) -> None: ...
    async def stop(self) -> None: ...


def verify_protocol_compliance():
    """
    Runtime verification that simulators implement protocols.
    Call this during test setup to catch drift early.
    """
    from .robot_simulators import MecaSimulator, OT2Simulator

    meca_sim = MecaSimulator()
    ot2_sim = OT2Simulator()

    # Check MecaSimulator compliance
    assert isinstance(meca_sim, MecaDriverProtocol), \
        "MecaSimulator does not implement MecaDriverProtocol!"

    # Check OT2Simulator compliance
    assert isinstance(ot2_sim, OT2DriverProtocol), \
        "OT2Simulator does not implement OT2DriverProtocol!"

    return True
